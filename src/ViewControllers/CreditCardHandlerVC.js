(function(){"use strict";var base=ViewControllerManager.findClass("ViewControllerNav");ViewControllerManager.newClassDef("CreditCardHandlerVC",Class.create({_extends_:base,_init_:function(args){base.call(this,args);this.activeChild="creditCardHandler_btn";this.navigation={};this.CCstate=undefined;this.CCfirstName=undefined;this.CClastName=undefined;this.CCnumber=undefined;this.CCmonth=undefined;this.CCyear=undefined;this.CCcvv=undefined;this.fullParam={name:'',number:'',exp_year:'',exp_month:'',cvc:''};this.stripeError=false;},onLoad:function(){},render:function(location){this._super(location);this.CCstate='firstName';this._populateFields();this._hideAllChecks();},onKeyDown:function(e,keyCode){TVA.log('keydown in Credit Card Handler');switch(keyCode){case Keys.getBind("Left"):var Keyboard=ViewControllerManager.find("Keyboard");TVA.setFocus(ViewControllerManager.find('Keyboard').activeChild);e.stopPropagation();break;case Keys.getBind("Cross"):case Keys.getBind("Enter"):$('#'+TVA.onFocus).click();e.stopImmediatePropagation();break;}},onHover:function(event){var element=event.target.id;this._enableElement(element);event.stopPropagation();},onUnload:function(){this.activeChild='';TVA.setFocus(this.activeChild);},onClick:function(){var _this=this;var Keyboard=ViewControllerManager.find('Keyboard');var inserted=Keyboard.insertedText;var errorMSG=$('#creditCardHandler_error');Model.App.monthInputActive=false;switch(_this.CCstate){case'firstName':if(inserted.length>0){_this.CCfirstName=inserted;_this.fullParam.name=_this.CCfirstName;Keyboard.resetInput();$('#creditCard_firstName').html(_this.CCfirstName);if(!_this.stripeError){$("#creditCardHandler_main_info").text(language[Model.App.file.language].creditCard.Info_lastName);_this._displayGreenCheck('creditCardTitle_firstName');errorMSG.text("");errorMSG.hide();_this.CCstate='lastName';}else{_this.stripeError=false;$('#creditCard_firstName').css('color','#555555');errorMSG.hide();_this._requestStripeToken();}}else{errorMSG.text(language[Model.App.file.language].creditCard.err_wrong_credentials);errorMSG.show();}
break;case'lastName':if(inserted.length>0){Model.App.maxInputLength=16;_this.CClastName=inserted;_this.fullParam.name+=' '+_this.CClastName;Keyboard.resetInput();$('#creditCard_lastName').html(_this.CClastName);if(!_this.stripeError){$("#creditCardHandler_main_info").text(language[Model.App.file.language].creditCard.Info_number);this._displayGreenCheck('creditCardTitle_lastName');errorMSG.text("");errorMSG.hide();Keyboard.changeToNumeric();_this.CCstate='number';}else{_this.stripeError=false;$('#creditCard_lastName').css('color','#555555');errorMSG.hide();_this._requestStripeToken();}}else{errorMSG.text(language[Model.App.file.language].creditCard.err_wrong_credentials);errorMSG.show();}
break;case'number':if(inserted.length>0){Model.App.maxInputLength=2;Model.App.monthInputActive=true;_this.CCnumber=inserted;_this.fullParam.number=_this.CCnumber;Keyboard.resetInput();$('#creditCard_number').html(_this.CCnumber);if(!_this.stripeError){$("#creditCardHandler_main_info").text(language[Model.App.file.language].creditCard.Info_month);this._displayGreenCheck('creditCardTitle_number');errorMSG.text("");errorMSG.hide();_this.CCstate='month';}else{_this.stripeError=false;$('#creditCard_number').css('color','#555555');errorMSG.hide();_this._requestStripeToken();}}else{errorMSG.text(language[Model.App.file.language].creditCard.err_wrong_credentials);errorMSG.show();}
break;case'month':if(inserted.length>0){Model.App.maxInputLength=2;if(inserted<10){_this.CCmonth='0'+inserted;}else{_this.CCmonth=inserted;}
_this.fullParam.exp_month=_this.CCmonth;Keyboard.resetInput();$('#creditCard_monthyear').html(_this.CCmonth+' / ');_this.CCstate='year';$("#creditCardHandler_main_info").text(language[Model.App.file.language].creditCard.Info_year);if(_this.stripeError){$('#creditCard_monthyear').css('color','#555555');_this._hideGreenCheck('creditCardTitle_monthyear');errorMSG.text("");errorMSG.hide();$('#creditCardHandler_btn').text(language[Model.App.file.language].creditCard.btn_addCard);}else{errorMSG.text("");errorMSG.hide();}}else{errorMSG.text(language[Model.App.file.language].creditCard.err_wrong_credentials);errorMSG.show();}
break;case'year':if(inserted.length>0){Model.App.maxInputLength=4;_this.CCyear=inserted;_this.fullParam.exp_year=_this.CCyear;Keyboard.resetInput();$('#creditCard_monthyear').html(_this.CCmonth+' / '+_this.CCyear);if(!_this.stripeError){$("#creditCardHandler_main_info").text(language[Model.App.file.language].creditCard.Info_cvv);this._displayGreenCheck('creditCardTitle_monthyear');errorMSG.text("");errorMSG.hide();$('#creditCardHandler_btn').text(language[Model.App.file.language].creditCard.btn_addCard);_this.CCstate='cvv';}else{_this.stripeError=false;errorMSG.hide();_this._requestStripeToken();}}else{errorMSG.text(language[Model.App.file.language].creditCard.err_wrong_credentials);errorMSG.show();}
break;case'cvv':if(inserted.length>0){Model.App.maxInputLength=255;_this.CCcvv=inserted;_this.fullParam.cvc=_this.CCcvv;$('#creditCard_cvv').html(this.CCcvv);Keyboard.resetInput();if(!_this.stripeError){errorMSG.text("");errorMSG.hide();}else{_this.stripeError=false;errorMSG.hide();}
this._requestStripeToken();}else{errorMSG.text(language[Model.App.file.language].creditCard.err_wrong_credentials);errorMSG.show();}
break;}},_displayGreenCheck:function(id){$('#'+id+' > .greenCheck').show();$('#'+id).css('padding-left','4px');},_displayAllChecks:function(){this._displayGreenCheck('creditCardTitle_lastName');this._displayGreenCheck('creditCardTitle_firstName');this._displayGreenCheck('creditCardTitle_number');this._displayGreenCheck('creditCardTitle_monthyear');this._displayGreenCheck('creditCardTitle_cvv');},_hideGreenCheck:function(id){$('#'+id+' > .greenCheck').hide();$('#'+id).css('padding-left','28px');},_hideAllChecks:function(){this._hideGreenCheck('creditCardTitle_lastName');this._hideGreenCheck('creditCardTitle_firstName');this._hideGreenCheck('creditCardTitle_number');this._hideGreenCheck('creditCardTitle_monthyear');this._hideGreenCheck('creditCardTitle_cvv');},_resetSamples:function(){var firstName=$("#creditCard_firstName");firstName.html('&nbsp');firstName.css('color','#555555');var lastName=$("#creditCard_lastName");lastName.html('&nbsp');lastName.css('color','#555555');var number=$("#creditCard_number");number.html('&nbsp');number.css('color','#555555');var monthyear=$("#creditCard_monthyear");monthyear.html('&nbsp');monthyear.css('color','#555555');var cvv=$("#creditCard_cvv");cvv.html('&nbsp');cvv.css('color','#555555');},_createParamString:function(){var str='';str+='card[name]='+this.fullParam.name;str+='&card[number]='+this.fullParam.number;str+='&card[exp_year]='+this.fullParam.exp_year;str+='&card[exp_month]='+this.fullParam.exp_month;str+='&card[cvc]='+this.fullParam.cvc;return str;},_requestStripeToken:function(){var _this=this;var Keyboard=ViewControllerManager.find('Keyboard');var Profile=ViewControllerManager.find('Profile');var Home=ViewControllerManager.find('Home');var input=$('#keyboardInput');var parameters=_this._createParamString();var success=function(result){_this._displayAllChecks();$('#creditCard_cvv').html(_this.CCcvv);$('#creditCard_cvv').css('color','#555555');var token=result.result;_this._storeNewCard(token);};var error=function(result){Util.hideSpriteLoader();var errorType=result.xhr.responseJSON.error.param;_this.handleStripeError(errorType);};Util.showSpriteLoader();API.stripeCard(parameters,success,error);},handleStripeError:function(str){var input=$('#keyboardInput');var errorMSG=$('#creditCardHandler_error');var Keyboard=ViewControllerManager.find('Keyboard');this.stripeError=true;switch(str){case'number':errorMSG.text(language[Model.App.file.language].creditCard.err_inserting_number);errorMSG.show();$('#creditCard_number').css('color','#ae1927');$("#creditCardHandler_main_info").text(language[Model.App.file.language].creditCard.Info_number);this._hideGreenCheck('creditCardTitle_number');input.html(this.CCnumber);Keyboard.insertedText=input.text();this.CCstate='number';break;case'exp_month':errorMSG.text(language[Model.App.file.language].creditCard.err_inserting_month);errorMSG.show();$('#creditCard_monthyear').css('color','#ae1927');$("#creditCardHandler_main_info").text(language[Model.App.file.language].creditCard.Info_month);this._hideGreenCheck('creditCardTitle_monthyear');$('#creditCardHandler_btn').html('Next');input.html(this.CCmonth);Keyboard.insertedText=input.text();this.CCstate='month';break;case'exp_year':errorMSG.text(language[Model.App.file.language].creditCard.err_inserting_year);errorMSG.show();$('#creditCard_monthyear').css('color','#ae1927');$("#creditCardHandler_main_info").text(language[Model.App.file.language].creditCard.Info_month);this._hideGreenCheck('creditCardTitle_monthyear');$('#creditCardHandler_btn').html('Next');input.html(this.CCmonth);Keyboard.insertedText=input.text();this.CCstate='month';break;case'cvc':errorMSG.text(language[Model.App.file.language].creditCard.err_inserting_cvv);errorMSG.show();$('#creditCard_cvv').css('color','#ae1927');$("#creditCardHandler_main_info").text(language[Model.App.file.language].creditCard.Info_cvv);this._hideGreenCheck('creditCardTitle_cvv');input.html(this.CCcvv);Keyboard.insertedText=input.text();this.CCstate='cvv';break;}
if(str!=='cvc'){this._displayGreenCheck('creditCardTitle_cvv');$('#creditCard_cvv').html(this.CCcvv);$('#creditCard_cvv').css('color','#555555');}else if(str!=='number'){this._displayGreenCheck('creditCardTitle_number');$('#creditCard_number').html(this.CCnumber);$('#creditCard_number').css('color','#555555');}else if(str!=='exp_year'&&str!=='exp_month'){this._displayGreenCheck('creditCardTitle_monthyear');$('#creditCard_monthyear').html(this.CCmonth+' / '+this.CCyear);$('#creditCard_monthyear').css('color','#555555');}},_storeNewCard:function(str){var scope=this;var a=str.id;var Keyboard=ViewControllerManager.find("Keyboard");var Home=ViewControllerManager.find("Home");var Profile=ViewControllerManager.find("Profile");var Details=ViewControllerManager.find("Details");var parameters={'token':a,'default':1};var success=function(result){API.getUser(function(result){Model.App.loggedIn=true;Model.App.file.user=result.result;Model.App.file.user.authToken=result.errorThrown.getResponseHeader('Authorization');Util.saveFile(Model.App.file);switch(Model.App.keyboardReturnTo){case'profile':Keyboard.removeChild('CreditCardHandler');Home.removeChild('Keyboard');Home.addChild(ViewControllerManager.find("Profile"),'#screens');Home.activeChild=Profile;Util.hideSpriteLoader();break;case'details':var params={card_id:Model.App.file.user.cards[Model.App.file.cardIndex||0].card_id,bundle:Model.App.file.bundle};API.buyTickets(params,function(res){API.useTicket(Model.App.movie.flix_id,function(res){Keyboard.removeChild('CreditCardHandler');Home.removeChild('Keyboard');$('#Details').show();Home._enableElement('Details');scope.parentVC.parentVC.onClose();Util.hideSpriteLoader();Model.App.file.user.ticket_count--;if(Model.App.file.user.ticket_count<0){Model.App.file.user.ticket_count=0;}
ViewControllerManager.find("Details").showPlayer();},function(res,errorCode){Model.App.errorCode=errorCode;scope.publish('Error');});},function(res,errorCode){Model.App.errorCode=errorCode;scope.publish('Error');});break;case'featured':scope.parentVC.parentVC.onClose();break;}},function(res,errorCode){Model.App.errorCode=errorCode;scope.publish('Error');});};var error=function(result,errorCode){Util.hideSpriteLoader();if(result.xhr.responseJSON.code==="incorrect_cvc"){scope.handleStripeError('cvc');}else{var b=result;Model.App.errorCode=errorCode;scope.publish('Error');}};API.storeNewCard(parameters,success,error);},_populateFields:function(){$("#creditCardHandler_main_info").text(language[Model.App.file.language].creditCard.Info_firstName);$("#creditCardHandler_error").text(language[Model.App.file.language].creditCard.err_wrong_credentials);$("#creditCardHandler_error").hide();$("#creditCardHandler_extra_info").text(language[Model.App.file.language].creditCard.labelsTitle);$("#creditCardHandler_btn").text(language[Model.App.file.language].loginScreen.btn_next);$("#creditCardTitle_firstName").html('<div class="greenCheck"></div>'+language[Model.App.file.language].creditCard.firstNameLabel);$("#creditCardTitle_lastName").html('<div class="greenCheck"></div>'+language[Model.App.file.language].creditCard.lastNameLabel);$("#creditCardTitle_number").html('<div class="greenCheck"></div>'+language[Model.App.file.language].creditCard.numberLabel);$("#creditCardTitle_monthyear").html('<div class="greenCheck"></div>'+language[Model.App.file.language].creditCard.monthyearLabel);$("#creditCardTitle_cvv").html('<div class="greenCheck"></div>'+language[Model.App.file.language].creditCard.cvvLabel);}}));})();