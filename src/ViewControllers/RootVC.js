(function(){"use strict";var base=ViewControllerManager.findClass("ViewControllerNav");ViewControllerManager.newClassDef("RootVC",Class.create({_extends_:base,locked:false,_init_:function(args){base.call(this,args);this.activeChild='Home';this.navigation={};this.categoryIndex=0;Model.App.loggedIn=false;},onLoad:function(){var scope=this;scope._loadApp();},_loadApp:function(){this.render();var scope=this;TVA.log('version 1.0.'+TVA.revision);var modal=ViewControllerManager.find("Modal");scope.addChild(modal,"#ModalContent");if(settings.device==='ps3'||settings.device==='ps4'||settings.device==='psvita'){$('#Root').addClass('playstation');}
Model.App.showPinBeforeDetails=true;Model.App.showFeatRegSuccess=false;Model.App.pinSet=false;Model.App.maxInputLength=255;Model.App.monthInputActive=false;API.getLocale(function(res){if(Model.App.file){Model.App.file['locale']=scope._optimiseLocaleData(res);}else{Model.App['file']={locale:scope._optimiseLocaleData(res)};}
API.getLanguages(function(res){Model.App.languages=res;language=Model.App.languages;if(Model.App.file&&!Model.App.file.language){for(var lang in Model.App.languages){Model.App.file.language=lang;Util.saveFile(Model.App.file);break;}}
if(Util.getFile()&&Util.getFile().user&&Util.getFile().user.authToken){Model.App['user']=Util.getFile().user;Model.App.loggedIn=true;Model.App.refreshLibrary=true;API.getUser(function(result){Model.App.file.user=result.result;Model.App.file.user.authToken=result.errorThrown.getResponseHeader('Authorization');Util.saveFile(Model.App.file);Model.App.loggedIn=true;scope.getMovies();API.getReminders(function(res){Model.App.reminders=res;},function(res,errorCode){Model.App.errorCode=errorCode;scope.publish('Error');});},function(res,errorCode){Model.App.file.user={};Util.saveFile(Model.App.file);Model.App.loggedIn=false;Model.App.errorCode=errorCode;scope.publish('Error');});}else{for(var lan in Model.App.languages){Util.saveFile({language:lan});break;}
Model.App.loggedIn=false;scope.getMovies();}},function(res,errorCode){Model.App.errorCode=errorCode;scope.publish('Error');});},function(res,errorCode){scope.hideSplash();scope.publish('Offline');});},render:function(location){this._super(location);},onHover:function(e){$('.hoverButton').removeClass('active');var parent=$('#'+e.target.id).parent()[0];var parentId=parent.id;if(parentId.indexOf('Grid')>-1){TVA.log(parentId.indexOf('Grid'));$('#Grid'+this.categoryIndex+' #'+e.target.id).addClass('active');}else{$('#'+e.target.id).addClass('active');}},onHoverOut:function(e){$('.hoverButton').removeClass('active');},onKeyDown:function(e,keyCode){TVA.log("keydown in root: "+keyCode);if(Model.App.listen){switch(keyCode){case Keys.getBind("Circle"):case Keys.getBind("Back"):this.exitApp();e.stopPropagation();break;case Keys.getBind("Exit"):this.exit();e.stopPropagation();break;case Keys.getBind("Up"):e.stopPropagation();break;case Keys.getBind("Left"):this.navLeft(e);e.stopPropagation();break;case Keys.getBind("Right"):this.navRight(e);e.stopPropagation();break;}}},hideSplash:function(){stopSpriteAnimation("splashLoader");var el=document.getElementById('splash');if(el.className!=='fadeOut'){el.className='fadeOut';setTimeout(function(){el.style.display="none";},1500);}
Model.App.listen=true;},_navigate:function(direction,e){var nextChild=this.navigation[this.activeChild][direction];if(nextChild&&this.children[nextChild]){this.children[nextChild].view.enable();e.stopPropagation();}else if($(this.rootID).find('#'+nextChild).length){TVA.setFocus(nextChild);this.activeChild=nextChild;e.stopPropagation();}},getMovies:function(call,error){var scope=this;API.getLocale(function(res){Model.App.file.locale=scope._optimiseLocaleData(res);API.getMenuList(function(data){var menuList=data.data;Model.App.menuId='';for(var i=0;i<menuList.length;i++){if(menuList[i].friendlyurl==='home'&&Model.App.file.locale.region===menuList[i].region){Model.App.menuId=menuList[i].id;break;}}
if(Model.App.menuId!==''){API.getMovies(function(data){Model.Movies['films']=data.playlist;var home=ViewControllerManager.find('Home');scope.addChild(home,'#AppContent');},function(res,errorCode){Model.App.errorCode=errorCode;scope.publish('Error');});}else{Model.App.errorCode=108;scope.publish('Error');scope.hideSplash();}},function(res,errorCode){scope.hideSplash();Model.App.errorCode=errorCode;scope.publish('Error');});},function(res,errorCode){scope.hideSplash();scope.publish('Offline');});},_optimiseLocaleData:function(objData){return{region:objData.region,app_config:objData.app_config,currency:objData.currency,ticket_sku:objData.ticket_sku,ticket_bundles:objData.ticket_bundles,view_pass_valid_hours:objData.view_pass_valid_hours,tickets:objData.tickets}},navLeft:function(e){this._navigate('Left',e);},navRight:function(e){this._navigate('Right',e);},exitApp:function(){Util.saveFile(Model.App.file);if(settings.device==='webos'){TVA.quit();}else{this.publish('Exit');}}}));})();