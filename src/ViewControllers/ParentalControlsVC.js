(function(){"use strict";var base=ViewControllerManager.findClass("ViewControllerNav");ViewControllerManager.newClassDef("ParentalControlsVC",Class.create({_extends_:base,_init_:function(args){base.call(this,args);this.activeChild='btn_pc_general';this.navigation={};this.askedPin='';this.restrictions='';},onLoad:function(){Model.App.profileState='parental';$('#backIcon').text(language[Model.App.file.language].common.btn_back);},render:function(location){Model.App.watchFromPin=false;this._super(location);if(settings.device==='lg'||settings.device==='webos'){$('#ParentalControlsContainer').css('background-image','url("./css/assets/background.png")');}
var self=this;this.askedPin=false;this._checkFirstTime(function(call){self.setup(call);});},setup:function(call){var self=this;var buttonsDiv=$('#PC_Buttons');if(this.restrictions===''){this._getRestrictionsInfo(function(result){self._createRestrictionsButtons();self._enableElement(buttonsDiv[0].children[0].id);$('.checkSignPC').hide();if(Model.App.loggedIn){var a=Model.App.file.user.parental_control?Model.App.file.user.parental_control.restriction:'';switch(a){case'G':$('#btn_pc_general >.checkSignPC').show();break;case'PG':$('#btn_pc_family > .checkSignPC').show();break;case'PG-13':$('#btn_pc_teens > .checkSignPC').show();break;case'R':$('#btn_pc_adults > .checkSignPC').show();break;default:$('.checkSignPC').hide();}}
self._populateFields();call&&call();},function(result,errorCode){Model.App.errorCode=errorCode;home.publish('Error');});}else{self._createRestrictionsButtons();self._enableElement(buttonsDiv[0].children[0].id);$('.checkSignPC').hide();if(Model.App.loggedIn){var a=Model.App.file.user.parental_control?Model.App.file.user.parental_control.restriction:'';switch(a){case'G':$('#btn_pc_general >.checkSignPC').show();break;case'PG':$('#btn_pc_family > .checkSignPC').show();break;case'PG-13':$('#btn_pc_teens > .checkSignPC').show();break;case'R':$('#btn_pc_adults > .checkSignPC').show();break;default:$('.checkSignPC').hide();}
call&&call();}}},onKeyDown:function(e,keyCode){var self=this;TVA.log('keydown in parental controls');var index=this._discoverButtonsIndex(TVA.onFocus);var buttonsDiv=$('#PC_Buttons');var length=buttonsDiv[0].children.length;$('#backIcon').removeClass('active');if(Model.App.listen){switch(keyCode){case Keys.getBind("Circle"):case Keys.getBind("Back"):this.goBack(e);e.stopPropagation();break;case Keys.getBind("Left"):if(TVA.onFocus==='btn_recover_pin'){self._enableElement('btn_change_pin');}
e.stopPropagation();break;case Keys.getBind("Right"):if(TVA.onFocus==='btn_change_pin'){self._enableElement('btn_recover_pin');}
e.stopPropagation();break;case Keys.getBind("Up"):if(index===0&&TVA.onFocus!=='btn_recover_pin'){self._enableElement('btn_change_pin');}else if(index>0){this._enableElement(buttonsDiv[0].children[index-1].id);}
e.stopPropagation();break;case Keys.getBind("Down"):if(TVA.onFocus==='btn_recover_pin'||TVA.onFocus==='btn_change_pin'){this._enableElement(buttonsDiv[0].children[0].id);}else if(index<length-1){this._enableElement(buttonsDiv[0].children[index+1].id);}
e.stopPropagation();break;case Keys.getBind("Cross"):case Keys.getBind("Enter"):$('#'+TVA.onFocus).click();e.stopPropagation();break;}}},_discoverButtonsIndex:function(str){var buttonsDiv=$('#PC_Buttons');var returnValue=0;var length=buttonsDiv[0].children.length;for(var i=0;i<length;i++){if(buttonsDiv[0].children[i].id===str){returnValue=i;}}
return returnValue;},onHover:function(event){var element=event.target.id;this._enableElement(element);event.stopPropagation();},doNothing:function(event){event.stopPropagation();},goBack:function(){$('#backIcon').removeClass('active');this.unload();var Profile=ViewControllerManager.find('Profile');var Home=ViewControllerManager.find("Home");Profile.removeChild('ParentalControls');Home.addChild(Profile,'#screens');},onUnload:function(){var buttonsDiv=$('#PC_Buttons');this._enableElement(buttonsDiv[0].children[0].id);$('#backIcon').text(language[Model.App.file.language].common.btn_menu);Model.App.profileState='profile';this.askedPin=false;$('#PC_Buttons').empty();},parentalControlClick:function(event){var aux=TVA.onFocus;switch(aux){case'btn_pc_general':case'btn_pc_family':case'btn_pc_teens':case'btn_pc_adults':this.askedPin=false;break;}
if(!this.askedPin&&aux!=='btn_recover_pin'&&aux!=='btn_change_pin'){Model.App.pinState='insert';var Root=ViewControllerManager.find("Root");Root.publish('PinInsert');$('#popup_pin_description').text(language[Model.App.file.language].pinScreen.verifyPin);}else{this._handleClicks(aux);}
event.stopPropagation();},_handleClicks:function(str){if(str!=='btn_recover_pin'&&str!=='btn_change_pin'){$('.checkSignPC').hide();var index=this._discoverButtonsIndex(str);var buttonsDiv=$('#PC_Buttons');var buttonID=buttonsDiv[0].children[index].id;$('#'+buttonID+'> .checkSignPC').show();var comparer=buttonID.substr(7,buttonID.length);var type=this._getRestrictionType(comparer);this._updateRestriction(type);}else if(str==="btn_recover_pin"){API.recoverPin(function(result){var Root=ViewControllerManager.find("Root");Root.publish('Information');$('#info_popup_description').html(language[Model.App.file.language].profileScreen.msg_recoverPin);},function(result,errorCode){Model.App.errorCode=errorCode;home.publish('Error');});event.stopPropagation();}else if(str==="btn_change_pin"){Model.App.pinState='insert_to_change';var Root=ViewControllerManager.find("Root");Root.publish('PinInsert');$('#popup_pin_description').text(language[Model.App.file.language].pinScreen.verifyPin);$('#popup_pin_error').hide();event.stopPropagation();}},_getRestrictionType:function(aux){var restrictions=this.restrictions;var length=this.restrictions.length;var result;for(var i=0;i<length;i++){if(restrictions[i].title.toLowerCase()===aux){result=restrictions[i].type;break;}}
return result;},_updateRestriction:function(str){var parameters={'pin':Model.App.file.user.pin,'restriction':str};API.setRestriction(parameters,function(result){if(Model.App.file.user.parental_control){Model.App.file.user.parental_control.restriction=str;Model.App.file.user.parental_control['is_active']=true;}else{Model.App.file.user['parental_control']={restriction:str};Model.App.file.user.parental_control['is_active']=true;}},function(result,errorCode){Model.App.errorCode=errorCode;home.publish('Error');});},_checkFirstTime:function(call){var Root=ViewControllerManager.find("Root");var sucess=function(result){Util.hideSpriteLoader();if(result.status===false){Model.App.pinState='create';call&&call(function(){Root.publish('PinInsert');$('#popup_pin_description').text(language[Model.App.file.language].pinScreen.setPin);});}else{call&&call();}};var error=function(result,errorCode){Util.hideSpriteLoader();Model.App.errorCode=errorCode;home.publish('Error');};Util.showSpriteLoader();API.checkPinSet(sucess,error);},_populateFields:function(){$('#btn_change_pin').text(language[Model.App.file.language].profileScreen.changePinButton);$('#btn_recover_pin').text(language[Model.App.file.language].profileScreen.recoverPinButton);$('#PC_Title').text(language[Model.App.file.language].profileScreen.parentalControlsButton);},_getRestrictionsInfo:function(onSuccess,onError){var self=this;Util.showSpriteLoader();API.getRestrictions(Model.App.file.language,function(result){Util.hideSpriteLoader();self.restrictions=result.restrictions;onSuccess&&onSuccess(result);},function(result,errorCode){onError&&onError(result,errorCode);});},_createRestrictionsButtons:function(){var restrictions=this.restrictions;var length=this.restrictions.length;var buttonsContainer=$('#PC_Buttons');var j=0;for(var i=0;i<length;i++){var info=restrictions[i].title+' - '+restrictions[i].info;var button=$('<div>');var classes=$('<div class="checkSignPC">');button.attr('id','btn_pc_'+restrictions[i].title.toLowerCase());button.attr('class','PC_ButtonsDef');button.text(info);button.append(classes);if(j>0){button.css('margin-top','15px');}
buttonsContainer.append(button);j++;}}}));})();