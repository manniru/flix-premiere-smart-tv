(function(){"use strict";var base=ViewControllerManager.findClass("ViewControllerNav");ViewControllerManager.newClassDef("RegisterHandlerVC",Class.create({_extends_:base,_init_:function(args){base.call(this,args);this.activeChild="registerHandler_btn";this.navigation={};this.secondPart=false;this.RegisterEmail=undefined;this.RegisterPassword=undefined;},onLoad:function(){},render:function(location){this._super(location);this._populateFields();},onKeyDown:function(e,keyCode){TVA.log('keydown in Register Handler');switch(keyCode){case Keys.getBind("Left"):var Keyboard=ViewControllerManager.find("Keyboard");TVA.setFocus(ViewControllerManager.find('Keyboard').activeChild);e.stopPropagation();break;case Keys.getBind("Cross"):case Keys.getBind("Enter"):$('#'+TVA.onFocus).click();e.stopPropagation();break;}},onHover:function(event){var element=event.target.id;this._enableElement(element);},onUnload:function(){this.activeChild='';TVA.setFocus(this.activeChild);},onClick:function(){var _this=this;var input=$('#keyboardInput');var Keyboard=ViewControllerManager.find('Keyboard');if(!_this.secondPart){if(Keyboard.insertedText!==""&&this.validateEmail(Keyboard.insertedText)){Keyboard.passwordMode=true;Keyboard.offset=10;$("#registerHandler_info").text(language[Model.App.file.language].loginScreen.password_register);$('#registerHandler_btn').text(language[Model.App.file.language].loginScreen.btn_register);_this.RegisterEmail=Keyboard.insertedText;_this.secondPart=true;input.empty();Keyboard.insertedText=input.text();$("#registerHandler_error").hide();input.css({"text-indent":"10px"});$('#keyboardInput').css('float','none');}else{$("#registerHandler_error").text(language[Model.App.file.language].loginScreen.err_no_username);$("#registerHandler_error").show();}}else{var aux=Keyboard.insertedText;if(aux.length>=6){$('#registerHandler_error').hide();Keyboard.passwordMode=false;_this.RegisterPassword=Keyboard.insertedText;_this.secondPart=false;input.empty();Keyboard.insertedText=input.text();this._createUser();}else{$("#registerHandler_error").text(language[Model.App.file.language].loginScreen.err_short_password);$('#registerHandler_error').show();}}},_createUser:function(){var _this=this;var Keyboard=ViewControllerManager.find('Keyboard');var Profile=ViewControllerManager.find('Profile');var Home=ViewControllerManager.find('Home');var input=$('#keyboardInput');var email=_this.RegisterEmail;var pass=_this.RegisterPassword;var parameters={'email':email,'password':pass};var success=function(result){Model.App.showFeatRegSuccess=true;Model.App.file['user']={'authToken':'','user':{'email':'','fullname':''}};Model.App.refreshLibrary=true;Model.App.file.user.authToken=result.errorThrown.getResponseHeader('Authorization');Model.App.file.user.user.email=email;Model.App.file.user.user.fullname='';Model.App.file.user.cards=[];Model.App.file.user.ticket_count=0;Util.saveFile(Model.App.file);Model.App.loggedIn=true;Util.hideSpriteLoader();$("#registerHandler_info").text(language[Model.App.file.language].loginScreen.email_register);$('#registerHandler_btn').text(language[Model.App.file.language].loginScreen.btn_next);$("#registerHandler_error").hide();Keyboard.removeChild('RegisterHandler');Keyboard.parentVC.onClose(function(){Home.publish('FeatRegSuccess');});};var error=function(result){Util.hideSpriteLoader();var aux=result.xhr.responseJSON.errors.email[0];if(aux==='The email must be a valid email address.'){$("#registerHandler_error").text(language[Model.App.file.language].loginScreen.err_invalid_email);}else if(aux==='This email is already in use.'){$("#registerHandler_error").text(language[Model.App.file.language].loginScreen.err_email_in_use);}
$("#registerHandler_info").text(language[Model.App.file.language].loginScreen.email_register);$('#registerHandler_btn').text(language[Model.App.file.language].loginScreen.btn_next);$("#registerHandler_error").show();input=$('#keyboardInput');input.html(_this.RegisterEmail);Keyboard.insertedText=input.text();clearTimeout(Keyboard.passwordTimeout);input.css('letter-spacing','1px');};API.createUser(parameters,success,error);Util.showSpriteLoader();},_automaticSignIn:function(){var scope=this;API.getUser(function(result){Model.App.loggedIn=true;Model.App.file.user=result.result;Util.saveFile(Model.App.file);},function(res,errorCode){Model.App.errorCode=errorCode;scope.publish('Error');});},_populateFields:function(){$('#registerHandler_btn').text(language[Model.App.file.language].loginScreen.btn_next);$("#registerHandler_info").text(language[Model.App.file.language].loginScreen.email_register);$("#registerHandler_error").text(language[Model.App.file.language].loginScreen.err_short_password);$("#registerHandler_error").hide();},validateEmail:function(email){var re=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return re.test(email);}}));})();