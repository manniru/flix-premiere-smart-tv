(function(){'use strict';var base=ViewControllerManager.findClass('ViewControllerNav');ViewControllerManager.newClassDef('DetailsVC',Class.create({_extends_:base,_init_:function(args){base.call(this,args);this.activeChild='mainMenu';this.navigation={mainMenu:{Right:'categoriesList'},categoriesList:{Left:'mainMenu'},NowShowing:{Left:'mainMenu'},Profile:{Left:'mainMenu'}};this.categoryIndex=0;this.showScreenTimeoutId=null;this.relatedData='';},onUnload:function(){this.removeChild('detailsList');},onLoad:function(){},render:function(location){var self=this;Model.App.keyboardReturnTo='details';if(TVA.device==='lg'||TVA.device==='webos'){$('#Details').css('background-image','url("./css/assets/background.png")');}
this._super(location);this.enable();self.buildView();Util.hideSpriteLoader();},onKeyDown:function(e,keyCode){TVA.log('keydown in Details');TVA.log(keyCode);$('#backIcon').removeClass('active');if(Model.App.listen){switch(keyCode){case Keys.getBind('Circle'):case Keys.getBind('Back'):this.back(e);e.stopPropagation();break;case Keys.getBind('Up'):break;case Keys.getBind('Down'):e.stopPropagation();break;case Keys.getBind('Left'):this._navigate('Left',e,keyCode);e.stopPropagation();break;case Keys.getBind('Right'):this._navigate('Right',e,keyCode);e.stopPropagation();break;case Keys.getBind('Cross'):case Keys.getBind('Enter'):$('#'+TVA.onFocus).click();e.stopPropagation();break;}}},_navigate:function(direction,e,keyCode){var nextChild=this.navigation[this.activeChild][direction];if(nextChild&&this.children[nextChild]){if(this.activeChild==='mainMenu'){this.goto(nextChild);}else if(this.activeChild==='categoriesList'){this.showSideMenu();}
this.children[nextChild].view.enable();e.stopPropagation();}else if($(this.rootID).find('#'+nextChild).length){TVA.setFocus(nextChild);this.activeChild=nextChild;e.stopPropagation();}},onHover:function(event){},buildView:function(){var self=this;var params={x:80,y:80,width:1120,height:560};WidgetManager.addWidget(self,'detailsList','#Details',{},params);self.createCarouselsList(Model.App.movie);Model.App.profileState='details';$('#backIcon').text(language[Model.App.file.language].common.btn_back);},detailsClick:function(e){Model.App.trailer=false;Model.App.refreshLibrary=true;var targetBtn=e.target.id;var detailsItems=language[Model.App.file.language].detailsScreen;var details=ViewControllerManager.find('Details');var destination=e.target.parentElement.innerText;if(destination.indexOf(detailsItems.btn_trailer)>-1){Model.App.trailer=true;details.prepareToShowPlayer();}else if(destination.indexOf(detailsItems.btn_watch)>-1){details.prepareToShowPlayer();}else if(destination.indexOf(detailsItems.btn_useTicket)>-1){Model.App.getTickets='use';Model.App.fromMyMovies=false;Model.App.fromProfile=false;Model.App.fromDetails=true;if(Model.App.loggedIn){this.publish('Purchase');}else{this.publish('SignReg');}}else if(destination.indexOf(detailsItems.btn_buyTicket)>-1){Model.App.getTickets='buy';Model.App.fromMyMovies=false;Model.App.fromProfile=false;Model.App.fromDetails=true;if(Model.App.loggedIn){this.publish('Purchase');}else{this.publish('SignReg');}}else if(destination.indexOf(detailsItems.btn_remind)>-1){if(Model.App.loggedIn){Util.showSpriteLoader();API.setReminder(Model.App.movie.flix_id,function(res){setTimeout(function(){API.getReminders(function(res){Util.hideSpriteLoader();if(Model.myMovies){Model.myMovies.films.reminders=res;}else{Model['myMovies']={films:{reminders:res}};}
Model.App.refreshLibrary=true;$('#successPopup').show();setTimeout(function(){$('#successPopup').hide();},2000);$('#successPopup').html(detailsItems.reminder.replace('[film]',Model.App.movie.title));var sel=targetBtn.replace('_Overlay','');$('#'+sel+' .content p').html(detailsItems.btn_reminderSet);},function(res,errorCode){Util.hideSpriteLoader();Model.App.errorCode=errorCode;details.publish('Error');});},2000);},function(res,errorCode){Util.hideSpriteLoader();Model.App.errorCode=errorCode;details.publish('Error');});}else{Model.App.fromMyMovies=false;Model.App.fromProfile=false;Model.App.fromDetails=true;this.publish('SignReg');}}else if(destination.indexOf(detailsItems.btn_reminderSet)>-1){Util.showSpriteLoader();API.cancelReminder(Model.App.movie.flix_id,function(res){setTimeout(function(){API.getReminders(function(res){Util.hideSpriteLoader();if(Model.myMovies){Model.myMovies.films.reminders=res;}else{Model['myMovies']={films:{reminders:res}};}
Model.App.refreshLibrary=true;var sel=targetBtn.replace('_Overlay','');$('#'+sel+' .content p').html(detailsItems.btn_remind);},function(res,errorCode){Util.hideSpriteLoader();Model.App.errorCode=errorCode;details.publish('Error');});},2000);},function(res,errorCode){Util.hideSpriteLoader();Model.App.errorCode=errorCode;details.publish('Error');});}else if(e.delegateTarget.id==='details_media'){var str=e.target.id;var pos=parseInt(str.substring(str.indexOf('pos_')+4,str.indexOf('_Overlay')));details.prepareToShowMediaPlayer(pos);}},detailsKeydown:function(e,keycode){switch(keycode){case Keys.getBind('Down'):Model.App.showDetailArrow='up';break;case Keys.getBind('Up'):Model.App.showDetailArrow='down';break;}},detailsHover:function(e){},detailsMouseOut:function(e){},movieReleased:function(){var released=true;var releaseDate=new Date(Model.App.movie.release_date);var currentDate=new Date().getTime();if(releaseDate>currentDate){released=false;}
return released;},rebuildView:function(){var carouselList=this.children['detailsList'].view;carouselList.reset();this.buildView();},createCarouselsList:function(id){var scope=this;var carouselList=this.children['detailsList'].view;carouselList.childIndex=0;carouselList.childIndexList={};$('#detailsList .CarouselsList_Container').css({top:'0px'});$('#categories').hide();var movie=Model.App.movie;var callBacks={clickCB:this.detailsClick,keydownCB:this.detailsKeydown,hoverCB:this.detailsHover,mouseOutCB:this.detailsMouseOut};var carouselData=[];var title='';var reminderSet=false;var movieReleased=this.movieReleased();var detailsItems=language[Model.App.file.language].detailsScreen;var call=function(){var scrn=$('#Screen');if(scrn.is(":visible")){TVA.log("SCREEN WAS VISIBLE");scrn.hide();}
title='';if(Model.App.movie.imagery.trailers.length>0){carouselData.push(detailsItems.btn_trailer);}
carouselList.addCarousel('details_watch',callBacks,carouselData,title);carouselData=[];title=detailsItems.media;var stills=movie.imagery.stills;if(stills){for(var i=0;i<stills.length;i++){carouselData.push(stills[i].id);}
carouselList.addCarousel('details_media',callBacks,carouselData,title);}
var children=ViewControllerManager.find('detailsList').children;ViewControllerManager.find('detailsList')._enableElement(children[Object.keys(children)[0]].view.name);if($('#ModalFeatRegSuccess #btn_exit')[0]){TVA.setFocus('btn_exit');}
if(Model.App.promptReview){scope.publish('Rating');}};if(Model.App.loggedIn){if(Model.myMovies&&Model.myMovies.films.reminders.length>0){for(var i=0;i<Model.myMovies.films.reminders.length;i++){if(Model.myMovies.films.reminders[i].id===Model.App.movie.flix_id){reminderSet=true;break;}}}
if(reminderSet){carouselData.push(detailsItems.btn_reminderSet);call();}else if(!movieReleased){carouselData.push(detailsItems.btn_remind);call();}else{API.moviePass(Model.App.movie.flix_id,function(res){if(res.pass_exists){carouselData.push(detailsItems.btn_watch);}else if(Model.App.file.user.ticket_count>0){carouselData.push(detailsItems.btn_useTicket);}else{carouselData.push(detailsItems.btn_buyTicket);}
call();},function(res,errorCode){Model.App.errorCode=errorCode;scope.publish('Error');});}}else{if(!movieReleased){carouselData.push(detailsItems.btn_remind);}else{carouselData.push(detailsItems.btn_buyTicket);}
call();}},relatedClick:function(){var Details=ViewControllerManager.find('Details');var pos=this.pos;var movie=Details.relatedData.related[pos];var movie_id=movie.id;Details.getRelatedMovieDetails(movie_id);},getRelatedMovieDetails:function(id){var self=this;var aux=$('#screens').find('#search_results');API.getMovie(id,function(data){if(aux.length>0){Model.App['returnFromDetailsTo']={parent:'search_results',screen:'search_results'};}
Model.App['movie']=data;self.removeChild('detailsList');self.watched=false;WidgetManager.addWidget(self,'detailsList','#Details',{},{});self._getRelatedData(function(result){self.createCarouselsList(Model.App.movie);$('#backIcon').text(language[Model.App.file.language].common.btn_back);},function(result,errorCode){Model.App.errorCode=errorCode;self.publish('Error');});$('#Screen').hide();},function(){Model.App.errorCode=errorCode;self.publish('Error');});},back:function(e){Model.App.showDetailArrow=null;Model.App.watched=false;Model.App.profileState='details';var home=ViewControllerManager.find('Home');home.back(e);$('#backIcon').text(language[Model.App.file.language].common.btn_menu);Model.App.profileState='screen';if(ViewControllerManager.find('Home').updateHome){ViewControllerManager.find('Home').updateHome=false;ViewControllerManager.find('Home').redrawFeaturedCarousel();ViewControllerManager.find('Home').enable();}},prepareToShowPlayer:function(){Model.App.seekTime=0;var root=ViewControllerManager.find('Root');var player=ViewControllerManager.find('Player');root.addChild(player,'#PlayerContent');$('#AppContent').hide();},prepareToShowMediaPlayer:function(position){var root=ViewControllerManager.find('Root');var player=ViewControllerManager.find('MediaPlayer');player.position=position;root.addChild(player,'#PlayerContent');$('#AppContent').hide();},_getRelatedData:function(onSuccess,onError){var self=this;var id=Model.App.movie.id;Util.showSpriteLoader();API.getRelated(id,function(result){Util.hideSpriteLoader();self.relatedData=result;onSuccess&&onSuccess(result);},function(result){onError&&onError(result);});},isotime:function(iso){if(iso){var arr=iso.split(new RegExp('-|T|:|\\.|\\+'));if(arr.length>6){}
if(arr[5][arr[5].length-1]==='Z'){arr[5]=arr[5].substring(0,arr[5].length-1);}
var isoDate=new Date(arr[0],arr[1]-1,arr[2],arr[3],arr[4],arr[5]);return isoDate.getTime();}}}));})();