(function(){"use strict";var base=ViewControllerManager.findClass("ViewControllerNav");ViewControllerManager.newClassDef("ModalPurchaseVC",Class.create({_extends_:base,_init_:function(args){base.call(this,args);this.activeChild='PayCC';this.navigation={};this.returnTo='';},onLoad:function(){},onUnload:function(){},render:function(location){this._super(location);this.enable();var scope=this;if(!Model.App.file.bundle){Model.App.file.bundle=1;}
if(Model.App.file.bundle===1){$('#ModalPurchase .buttons').addClass('single');$('#ModalPurchase .buttons').removeClass('bundle');}else{$('#ModalPurchase .buttons').addClass('bundle');$('#ModalPurchase .buttons').removeClass('single');}
var strings=language[Model.App.file.language].purchaseScreen;$('#PayCC').html(strings.btn_buyTicket);$('#Paytickets').html(strings.btn_useTicket);$('#PayNowTicket').html(strings.btn_payTicket);$('#btnConfirmCC').html(strings.btn_change_cc);$('#PayNow').html(strings.btn_pay);$('#ModalPurchase #back').html(language[Model.App.file.language].common.btn_back);Util.showSpriteLoader();API.getTickets(function(res){Model.App.file.user.ticket_count=res.ticket_count;API.getCards(function(res){Util.hideSpriteLoader();Model.App.file.user.cards=res.result;if(Model.App.getTickets==='buy'){scope.showCreditCardSection();}else{scope.showTicketSection();}},function(res,errorCode){Model.App.errorCode=errorCode;scope.publish('Error');});},function(res,errorCode){Model.App.errorCode=errorCode;scope.publish('Error');});},onKeyDown:function(e,keyCode){TVA.log('keydown '+this.name);if(Model.App.listen){switch(keyCode){case Keys.getBind("Circle"):case Keys.getBind("Back"):this.back();e.stopPropagation();break;case Keys.getBind("Exit"):this.exit();e.stopPropagation();break;case Keys.getBind("Up"):this._navigate("Up",e);e.stopPropagation();break;case Keys.getBind("Down"):this._navigate("Down",e);e.stopPropagation();break;case Keys.getBind("Left"):this._navigate("Left",e);e.stopPropagation();break;case Keys.getBind("Right"):this._navigate("Right",e);e.stopPropagation();break;case Keys.getBind("Cross"):case Keys.getBind("Enter"):$('#'+TVA.onFocus).click();e.stopPropagation();break;}}},_navigate:function(direction,e){var nextChild=this.navigation[this.activeChild][direction];if(nextChild==='btnConfirmCC'){$('#cardList .gridElement.active').removeClass('active');}
if(nextChild&&this.children[nextChild]){this.children[nextChild].view.enable();e.stopPropagation();}else if($(this.rootID).find('#'+nextChild).length){TVA.setFocus(nextChild);this.activeChild=nextChild;e.stopPropagation();}},menuMouseOut:function(e){},onBtnClick:function(e){var scope=ViewControllerManager.find('ModalPurchase');var details=ViewControllerManager.find('Details');var targetId=e.target.id;if(targetId.indexOf('Grid')>-1){targetId='gridItem';}
switch(targetId){case'gridItem':scope.selectCard(this.row);break;case'btnConfirmCC':scope.confirmCard();break;case'ChangeCC':scope.showChangeCreditCardSection();break;case'PayNowTicket':this.useTicket();break;case'PayCC':scope.showCreditCardSection();break;case'Paytickets':scope.showTicketSection();break;case'SelectSingle':Model.App.file.bundle=1;Util.saveFile(Model.App.file);$('#ModalPurchase .buttons').addClass('single');$('#ModalPurchase .buttons').removeClass('bundle');break;case'SelectBundle':Model.App.file.bundle=5;Util.saveFile(Model.App.file);$('#ModalPurchase .buttons').addClass('bundle');$('#ModalPurchase .buttons').removeClass('single');break;case'PayNow':if(settings.device==='firetv'){var sku='';if(Model.App.file.bundle===1){sku=Model.App.file.locale.ticket_sku;}else if(Model.App.file.bundle===5){sku=Model.App.file.locale.ticket_bundles[0].sku;}
TVA.AmazonIAP.purchaseItem(sku,function(message){Model.App.errorCode=null;Model.App.message=message;scope.publish('Message');});}else if(Model.App.file.user.cards.length>0){Util.showSpriteLoader();var params={card_id:Model.App.file.user.cards[Model.App.file.cardIndex||0].card_id,bundle:Model.App.file.bundle};API.buyTickets(params,function(res){Model.App.file.user.ticket_count=res.result.new_ticket_count;API.useTicket(Model.App.movie.flix_id,function(res){scope.back();Model.App.file.user.ticket_count--;if(Model.App.file.user.ticket_count<0){Model.App.file.user.ticket_count=0;}
details.prepareToShowPlayer();Util.hideSpriteLoader();},function(res,errorCode){Util.hideSpriteLoader();Model.App.errorCode=errorCode;scope.publish('Error');});},function(res,errorCode){if(res.xhr.responseJSON.code==="card_declined"){Util.hideSpriteLoader();Model.App.errorCode=errorCode;Model.App.message=res.xhr.responseJSON.message;scope.publish('Message');}else{Util.hideSpriteLoader();Model.App.errorCode=errorCode;scope.publish('Error');}});}else{scope.back();scope.publish('CreditCardMenu');}
break;}},back:function(){$(this.rootID+' .active').removeClass('active');var scope=this;switch(this.returnTo){case'cards':scope.returnTo='';$('.selectMethod').show();scope.showCreditCardSection();break;case'tickets':break;default:this.parentVC.backToPrevious();break;}},onMouseLeave:function(e){$('#'+e.target.id).removeClass('active');},onBackHover:function(e){$('#'+e.target.id).addClass('active');},onHover:function(event){$('#cardList .gridElement.active').removeClass('active');this._enableElement(event.target.id);event.stopPropagation();},useTicket:function(){Util.showSpriteLoader();var details=ViewControllerManager.find('Details');var scope=this;API.useTicket(Model.App.movie.flix_id,function(res){scope.back();Model.App.file.user.ticket_count--;if(Model.App.file.user.ticket_count<0){Model.App.file.user.ticket_count=0;}
details.prepareToShowPlayer();Util.hideSpriteLoader();},function(res,errorCode){Model.App.errorCode=errorCode;scope.publish('Error');});},showTicketSection:function(){$('.selectMethod .Paytickets').addClass('active');$('.selectMethod .PayCC').removeClass('active');$('.creditCardSection').hide();$('.changeCreditCardSection').hide();$('.ticketSection').show();this.activeChild='Paytickets';this._enableElement(this.activeChild);var detailsEl=$('.ticketSection .details');var strings=language[Model.App.file.language].purchaseScreen;var availableTickets=strings.ticketsAvailable.replace('[ticketCount]',Model.App.file.user.ticket_count);detailsEl.find('.ticketCount').html(availableTickets);detailsEl.find('.movietitle').html(Model.App.movie.title);var availableTime=strings.filmAvailable.replace('[hours]',Model.App.file.locale.view_pass_valid_hours);detailsEl.find('.availability').html(availableTime);$('.header').html(strings.confirm);this.navigation={PayCC:{Right:'Paytickets'},Paytickets:{Left:'PayCC'},PayNowTicket:{Up:'Paytickets'}};if(Model.App.file.user.ticket_count>0){this.navigation.PayCC.Down='PayNowTicket';this.navigation.Paytickets.Down='PayNowTicket';$('#PayNowTicket').removeClass('disabled');}else{$('#PayNowTicket').addClass('disabled');}},showChangeCreditCardSection:function(){this.returnTo='cards';$('.creditCardSection').hide();$('.ticketSection').hide();$('.selectMethod').hide();$('.changeCreditCardSection').show();this.activeChild='btnConfirmCC';this._enableElement(this.activeChild);this.navigation={btnConfirmCC:{Up:'ccList'},ccList:{Down:'btnConfirmCC'}};var strings=language[Model.App.file.language].common;$('.header').html(strings.confirm);var carouselData=[];for(var i=0;i<Model.App.file.user.cards.length;i++){var card=Model.App.file.user.cards[i];var cardNumber=card.last4;var month=card.exp_month;var year=card.exp_year;var cardInfo='<span>'+strings.card+': ****'+cardNumber+'</span><span>'+strings.expiry+':'+month+'/'+year+'</span>';carouselData.push(cardInfo);}
var callBacks={clickCB:this.onBtnClick,mouseOutCB:this.menuMouseOut};var params={carouselData:carouselData};WidgetManager.addWidget(this,'ccList','#cardList',callBacks,params);},showCreditCardSection:function(){$('.creditCardSection').show();$('.ticketSection').hide();var strings=language[Model.App.file.language].purchaseScreen;$('.header').html(strings.paymentMethod);var locale=Model.App.file.locale;$('#SelectSingle').html(locale.tickets[locale.currency][0].title);$('#SelectBundle').html(locale.tickets[locale.currency][1].title);this.drawCardInfo();$('.selectMethod .PayCC').addClass('active');$('.selectMethod .Paytickets').removeClass('active');$('.changeCreditCardSection').hide();var detailsEl=$('.creditCardSection .details');detailsEl.find('.movietitle').html(Model.App.movie.title);var availableTime=strings.filmAvailable.replace('[hours]',locale.view_pass_valid_hours);detailsEl.find('.availability').html(availableTime);this.activeChild='PayCC';this._enableElement(this.activeChild);this.navigation={PayCC:{Down:'SelectSingle',Right:'Paytickets'},Paytickets:{Down:'SelectSingle',Left:'PayCC'},SelectSingle:{Up:'PayCC',Down:'SelectBundle'},SelectBundle:{Up:'SelectSingle',Down:'PayNow'},PayNow:{Up:'SelectBundle'},ChangeCC:{Up:'SelectBundle',Left:'PayNow'}};$('.creditCardSection .buttons').removeClass('multiCards');if(Model.App.file.user.cards.length>1&&settings.device!=='firetv'){this.navigation.PayNow.Right='ChangeCC';$('.creditCardSection .buttons').addClass('multiCards');}
if(Model.App.loggedIn){this.navigation.PayCC.Right='Paytickets';}
$('#ChangeCC').html(strings.btn_change_cc);},drawCardInfo:function(){if(settings.device!='firetv'){var strings=language[Model.App.file.language].common;$('#ModalPurchase .creditCardSection .card').html('');if(Model.App.file.user.cards&&Model.App.file.user.cards.length>0){var card=Model.App.file.user.cards[Model.App.file.cardIndex||0];var cardNumber=card.last4;var month=card.exp_month;var year=card.exp_year;var cardInfo='<span>'+strings.card+': ****'+cardNumber+'</span><span>'+strings.expiry+':'+month+'/'+year+'</span>';$('#ModalPurchase .creditCardSection .card').html(cardInfo);}}},selectCard:function(index){this.cardIndex=index;var items=$('#ccList .check');items.removeClass('active');$(items[this.cardIndex]).addClass('active');},confirmCard:function(){var scope=ViewControllerManager.find('ModalPurchase');Model.App.file.cardIndex=this.cardIndex;Util.saveFile(Model.App.file);scope.back();}}));})();