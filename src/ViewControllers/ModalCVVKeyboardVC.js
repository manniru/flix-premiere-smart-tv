(function(){'use strict';var base=ViewControllerManager.findClass('ViewControllerNav');ViewControllerManager.newClassDef('ModalCVVKeyboardVC',Class.create({_extends_:base,_init_:function(args){base.call(this,args);this.activeChild='keyboard-0-0';this.navigation={};this.deleteTimeout=undefined;this.lettersFirstRow=['2','3','4','5'];this.lettersSecondRow=['6','7','8','9','0'];this.numbersThirdRow=['1','2','3','4','5','6','7','8','9','0'];},onLoad:function(){TVA.log('loading CVV Keyboard');},onUnload:function(){$('.CVVKeyboardInput p').empty();$(this.rootID+' .errorMessage').hide();},render:function(location){this._super(location);this.enable();TVA.setFocus('keyboard-0-0');if($(this.rootID+' #keyboard-0-1').length===0){this._appendLettersToDiv(this.lettersFirstRow,'.CVVKeyboardFirstRow','0');this._appendLettersToDiv(this.lettersSecondRow,'.CVVKeyboardSecondRow','1');$(this.rootID+' .text').text(strings.keyboard.text);$(this.rootID+' #CVVKeyboardBtn .btn').text(strings.keyboard.continue);}},_appendLettersToDiv:function(lettersArray,divClass,row){lettersArray.forEach(function(element,index){var letterContainer=$('<div>');if(row==='1'){letterContainer.attr('id','keyboard-'+row+'-'+(index));}else if(row==='2'){letterContainer.attr('id','keyboard-'+row+'-'+(index+2));}else{letterContainer.attr('id','keyboard-'+row+'-'+(index+1));}
letterContainer.addClass('CVVKeyboardKey hoveritem');var focusDiv=$('<div>');letterContainer.append(focusDiv);var letter=$('<span>').text(element);letterContainer.append(letter);$(divClass+' > .CVVKeyboardLetters').append(letterContainer);});},onKeyDown:function(e,keyCode){var scope=this;var auxIdRow=parseInt(e.target.id.slice(e.target.id.indexOf('-')+1,e.target.id.lastIndexOf('-')));var auxIdColumn=parseInt(e.target.id.slice(e.target.id.lastIndexOf('-')+1));switch(keyCode){case Keys.getBind('Up'):if(auxIdRow===0){this.curCharUP=TVA.onFocus;TVA.setFocus('CVVKeyboardBtn');}else if(auxIdRow===1||auxIdRow===2){if(TVA.onFocus==='keyboard-2-12'){if(this.curCharDOWN){TVA.setFocus(this.curCharDOWN);}else{setFocusAndActive('keyboard-1-4');}
this.curCharDOWN='';}else{setFocusAndActive('keyboard-'+(auxIdRow-1)+'-'+auxIdColumn);}}else if(TVA.onFocus==='kbBack_btn'){TVA.setFocus('CVVKeyboardBtn');this.curCharDOWN='';}else if(TVA.onFocus==='CVVKeyboardBtn'){if(this.curCharDOWN){TVA.setFocus(this.curCharDOWN);}else{setFocusAndActive('keyboard-1-0');}
this.curCharDOWN='';}
e.stopPropagation();break;case Keys.getBind('Down'):if(TVA.onFocus==='CVVKeyboardBtn'){}else if(auxIdRow===1){this.curCharDOWN=TVA.onFocus;TVA.setFocus('CVVKeyboardBtn');}else if(auxIdRow===0||auxIdRow===1){setFocusAndActive('keyboard-'+(auxIdRow+1)+'-'+auxIdColumn);}else if(auxIdRow===1){this.curCharDOWN=TVA.onFocus;TVA.setFocus('CVVKeyboardBtn');}
e.stopPropagation();break;case Keys.getBind('Left'):if(auxIdRow===2&&auxIdColumn===2){setFocusAndActive('keyboard-2-0');}else if(TVA.onFocus==='keyboard-2-12'){TVA.setFocus('CVVKeyboardBtn');}else if(auxIdColumn>0){setFocusAndActive('keyboard-'+auxIdRow+'-'+(auxIdColumn-1));e.stopPropagation();}
break;case Keys.getBind('Right'):if(auxIdRow===0&&auxIdColumn<this.lettersFirstRow.length){setFocusAndActive('keyboard-0-'+(auxIdColumn+1));}else if(auxIdRow===1&&auxIdColumn<this.lettersSecondRow.length-1){setFocusAndActive('keyboard-1-'+(auxIdColumn+1));}else if(auxIdRow===2&&auxIdColumn===0){setFocusAndActive('keyboard-2-2');}else if(auxIdRow===2&&auxIdColumn<this.numbersThirdRow.length+2){setFocusAndActive('keyboard-2-'+(auxIdColumn+1));}else if(TVA.onFocus==='CVVKeyboardBtn'){TVA.setFocus('keyboard-2-12');}
e.stopPropagation();break;case Keys.getBind('Enter'):$('#'+TVA.onFocus).click();e.stopPropagation();break;case Keys.getBind('Circle'):case Keys.getBind('Back'):this.onBack();e.stopPropagation();break;}
function setFocusAndActive(id){scope.activeChild=id;TVA.setFocus(id);}},onBack:function(){$(this.rootID+' .active').removeClass('active');this.parentVC.backToPrevious();},onMouseLeave:function(e){$('#'+e.target.id).removeClass('active');},onBackHover:function(e){$('#'+e.target.id).addClass('active');},onHover:function(event){if(event.target.id===''){this._enableElement(event.target.parentElement.id);}else{this._enableElement(event.target.id);}
event.stopPropagation();},onKeyClick:function(event){$(this.rootID+' .errorMessage').hide();var input=$('.CVVKeyboardInput > p');if(input.text().replace(/ /g,'').length<3){input.append($('#'+TVA.onFocus).text().trim());}},onSpaceClick:function(event){$(this.rootID+' .errorMessage').hide();var input=$('.CVVKeyboardInput > p');input.append(' ');},onDeleteClick:function(event){$(this.rootID+' .errorMessage').hide();var input=$('.CVVKeyboardInput > p');input.text(input.text().slice(0,input.text().length-1));},onSubmit:function(){var scope=this;var input=$('.CVVKeyboardInput > p').text();Util.showSpinner();var params={PaymentOptionId:Model.PaymentOptions[Model.Basket.PaymentIndex||0].Id,CVV:input,orderId:Model.Basket.OrderId,type:'card'};ViewControllerManager.find('Basket').sendPayment(params,function(a){Util.showSpinner();scope.getOrderStatus();},function(a){if(a.xhr.status===202){Util.showSpinner();scope.getOrderStatus();}else{ViewControllerManager.find('Basket').publish('CVVFailedPopup');}});},getOrderStatus:function(){var params={orderId:Model.Basket.OrderId};var scope=this;setTimeout(function(){API.getOrderStatus(params,function(a){if(a.Status===40000){scope.parentVC.backToPrevious();ViewControllerManager.find('Basket').publish('CVVFailedPopup');}else if(a.Status===20000){Util.hideSpinner();scope.parentVC.backToPrevious();var complete=ViewControllerManager.find("OrderCompleteStatus");ViewControllerManager.find("Root").addChild(complete,"#AppContent");}else{scope.getOrderStatus();}},function(a){scope.parentVC.backToPrevious();ViewControllerManager.find('Basket').publish('CVVFailedPopup');});},500);},onSearch:function(){var input=$('.CVVKeyboardInput > p').text();var reg2=/^s*([A-z]{1,2}[ ]?[0-9]{1,2}[A-z]?[ ]*[0-9][A-z]{2})\s*$/;var scope=this;if(reg2.test(input)){Util.showSpinner();var root=ViewControllerManager.find('Root');root.getRestaurants({postcode:input.replace(/ /g,'')},function(){var data=[];data=Model.Cuisines;if(Model.PreviousOrders){var ordersObj={Name:'Previous Orders',SeoName:'previousOrders'};data.unshift(ordersObj);}
ViewControllerManager.find('Cuisines').createCuisineList(data);Util.saveFile({postCode:input});$('#settingsBtn p').html(input);$('#ModalContent').hide();$('#Applogo').removeClass('minimisedLogo');$('#Applogo').addClass('mainCuisines');$('#restaurantList').hide();$('#settingsBtn').hide();$('#cuisineList').removeClass('mini');$('#Cuisines').removeClass('active');$('#Cuisines').addClass('main');Util.hideSpinner();scope.parentVC.removeChild('ModalCVVKeyboard');},function(){Util.hideSpinner();Model.App.listen=true;$(scope.rootID+' .errorMessage').text(strings.keyboard.errorNoResults);$(scope.rootID+' .errorMessage').show();});}else{$(scope.rootID+' .errorMessage').text(strings.keyboard.errorPostCode);$(scope.rootID+' .errorMessage').show();}}}));})();