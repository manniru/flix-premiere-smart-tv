(function(){"use strict";ViewControllerManager.newClassDef("CarouselVC",Class.create({_extends_:ViewController,_init_:function(args){ViewController.call(this,args);this.id=this.name+'_carouselVC';this.options=Model.newModel(this.id,{autoselect:false,animation:0,transition:false,vertical:false,wrap:null,style:'default',limitedItems:false,topElementId:null,bottomElementId:null,leftElementId:null,rightElementId:null,backElementId:null});this.autoselectTimeout=null;this.menu=null;this.pos=0;this.activePos=0;this.offset=0;this.status={blocked:false};},onLoad:function(){},onUnload:function(){},render:function(location){this._super(location);},onKeyDown:function(e,keyCode){switch(keyCode){case Keys.getBind("Up"):this.navTopElement(e);break;case Keys.getBind("Down"):this.navBottomElement(e);break;case Keys.getBind("Left"):if(!this.options.rtl)this.navLeftElement(e);else this.navRightElement(e);break;case Keys.getBind("Right"):if(!this.options.rtl)this.navRightElement(e);else this.navLeftElement(e);break;case Keys.getBind("Enter"):this.selectCurrentElement(e);break;default:break;}},configure:function(model,options,dataField){Model.updateModel(this.id,options);this.model=model;this.dataField=dataField||'data';this.updateData();},updateData:function(){this.model=Model.getModel(this.model);this.draw();},enable:function(){this.show();$(this.menu.jcarousel('items')[this.pos]).trigger('mouseenter');},isFocused:function(){return $(this.rootID).find('.focus').length>0;},draw:function(offset){var self=this;this.offset=offset||0;this.offset=(this.options.limitedItems)?this.offset/this.options.limitedItems:0;$(this.rootID).empty().css({position:'absolute',left:20000,top:0});this.menu=$('<div class="'+this.options.style+'"></div>');var list=$('<ul></ul>');var limited=false;if(this.options.limitedItems)limited=true;for(var i=this.offset;i<this.model[this.dataField].length&&(!limited||i<this.options.limitedItems+this.offset);i++){list.append(this._createElement(this.model[this.dataField][i]));}
this.menu.append(list);this._addCarouselEvents();$(this.rootID).append(this.menu);this.menu.jcarousel(this.options);if(jQuery().dotdotdot)window.setTimeout(function(){$(self.rootID).find('.ellipsis').dotdotdot({wrap:'letter'});},200);if(jQuery().lazyload)window.setTimeout(function(){$(self.rootID).find('img.lazy').lazyload();},200);$(this.rootID).css({position:'',left:'',top:''});},_addCarouselEvents:function(){this.menu.on('jcarousel:createend',{menuObject:this},function(event,carousel){var menuObject=event.data.menuObject;menuObject.size=menuObject.menu.jcarousel('items').size();if(menuObject.options.header)menuObject._addHeader();if(menuObject.options.currentView)menuObject._addCurrentView();if(menuObject.options.controls)menuObject._addCarouselControls();}).on('jcarousel:animate',{menuObject:this},function(event,carousel,target,animate){var menuObject=event.data.menuObject;menuObject.status.blocked=true;}).on('jcarousel:animateend',{menuObject:this},function(event,carousel){var menuObject=event.data.menuObject;if(menuObject.options.limitedItems)menuObject._updateCarousel();menuObject.status.blocked=false;}).on('jcarousel:scroll',{menuObject:this},function(event,carousel,target,animate){var menuObject=event.data.menuObject;if(menuObject.options.loadingIcon)$(menuObject.options.loadingIcon).show();}).on('jcarousel:scrollend',{menuObject:this},function(event,carousel,target,animate){var menuObject=event.data.menuObject;if(menuObject.options.currentView)menuObject._updateCurrentView(menuObject.pos);if(menuObject.options.loadingIcon)$(menuObject.options.loadingIcon).hide();menuObject._scrollControl();}).on('jcarousel:reloadend',{menuObject:this},function(event,carousel){var menuObject=event.data.menuObject;menuObject.status.blocked=false;if(menuObject.options.currentView)menuObject._updateCurrentView(menuObject.pos);if(menuObject.options.loadingIcon)$(menuObject.options.loadingIcon).hide();});},_scrollControl:function(){if(this.menu.jcarousel('first').index()>this.pos)this._focusItem(this.menu.jcarousel('first').index());else if(this.menu.jcarousel('last').index()<this.pos)this._focusItem(this.menu.jcarousel('last').index());},_createElement:function(item){var element=$('<li id="'+this.id+'_'+item.id.toString().replace(/\s+/g,'_')+'"><div class="outerContainer"><div class="innerContainer"><div class="element">'+item.content+'</div></div></div></li>');element.addClass('hoveritem');return element;},onClick:function(event){$(event.currentTarget).parent().find('.active').removeClass('active');$(event.currentTarget).addClass('active');this.pos=this.activePos=$(event.currentTarget).index();this.menu.jcarousel('scrollIntoView',this.pos);this.model[this.dataField][this.pos+this.offset].action();event.stopPropagation();},onMouseEnter:function(event){var onFocus=TVA.onFocus,target=event.currentTarget.id;if(onFocus!==target){TVA.offFocus(TVA.onFocus);TVA.setFocus(target);}
this.pos=$(event.currentTarget).index();if(this.options.currentView)this._updateCurrentView(this.pos);this.menu.jcarousel('scrollIntoView',this.pos);this._autoSelectManagement();this.parentVC.setActiveChild(this.name);event.stopPropagation();},_updateCarousel:function(){var sizeLimited=this.size;if(this.model[this.dataField].length>sizeLimited){var sliceInit=this.offset;var sliceEnds=sliceInit+sizeLimited;if((this.menu.jcarousel('last').index()==this.size-1)&&this.model[this.dataField].length>sliceEnds){this.offset++;sliceInit=this.offset;sliceEnds=this.offset+sizeLimited;this.menu.find('ul').append(this._createElement(this.model[this.dataField][sliceEnds-1]));this.menu.jcarousel('items').slice(0,1).remove();this.pos--;this.menu.jcarousel('reload');}
else if(this.menu.jcarousel('first').index()===0&&this.offset>0){this.offset--;sliceInit=this.offset;sliceEnds=sliceInit+sizeLimited;this.menu.find('ul').prepend(this._createElement(this.model[this.dataField][sliceInit]));this.menu.jcarousel('items').slice(this.size-1,this.size).remove();this.pos++;this.menu.jcarousel('reload');}}},_addHeader:function(){this.header=$('<div class="'+this.options.style+'-header"><div class="'+this.options.style+'-title">'+this.options.header.title+'</div><div class="'+this.options.style+'-subtitle">'+this.options.header.subtitle+'</div></div>');$(this.rootID).prepend(this.header);},_addCurrentView:function(){this.currentView=$('<div class="'+this.options.style+'-currentOption"></div>');$(this.rootID).prepend(this.currentView);},_updateCurrentView:function(pos){this.currentView.empty();this.currentView.append(typeof this.options.currentView.content=="function"?this.options.currentView.content():this.options.currentView.content);},_addCarouselControls:function(){this.control_prev=$('<div class="'+this.options.style+'-prev" href="#">'+this.options.controls.prev+'</div>').addClass('pointer itemhover');this.control_next=$('<div class="'+this.options.style+'-next" href="#">'+this.options.controls.next+'</div>)').addClass('pointer itemhover');$(this.rootID).prepend(this.control_prev).append(this.control_next);this.control_next.on('jcarouselcontrol:inactive',function(){$(this).addClass('inactive');})
.on('jcarouselcontrol:active',function(){$(this).removeClass('inactive');}).jcarouselControl({target:'+=1',carousel:this.menu,method:'scroll'});this.control_prev.on('jcarouselcontrol:inactive',function(){$(this).addClass('inactive');})
.on('jcarouselcontrol:active',function(){$(this).removeClass('inactive');}).jcarouselControl({target:'-=1',carousel:this.menu,method:'scroll'});},_autoSelectManagement:function(){if(this.options.autoselect){var _this=this;window.clearTimeout(this.autoselectTimeout);this.autoselectTimeout=window.setTimeout(function(){if(_this.pos!=_this.activePos&&$(_this.rootID).is(':visible'))_this.selectCurrentElement();},this.options.autoselect);}},_prevItem:function(){if(this.pos>0)this.pos--;var element=$(this.menu.jcarousel('items')[this.pos]);element.trigger('mouseenter');},_nextItem:function(){if(this.pos+1<this.size)this.pos++;var element=$(this.menu.jcarousel('items')[this.pos]);element.trigger('mouseenter');},_focusItem:function(pos){this.pos=pos;var element=$(this.menu.jcarousel('items')[this.pos]);element.trigger('mouseenter');},selectCurrentElement:function(e){var element=$(this.menu.jcarousel('items')[this.pos]);element.trigger('click');if(e)e.stopPropagation();},selectElementById:function(id,force){if(typeof id!='string')id=id.toString();this._checkElementIdInsideList(id);var element=this.menu.find('#'+this.id+'_'+id.toString().replace(/\s+/g,'_'));if(force||element.index()!=this.activePos)element.trigger('click');},focusElementById:function(id){if(typeof id!='string')id=id.toString();this._checkElementIdInsideList(id);var element=this.menu.find('#'+this.id+'_'+id.replace(/\s+/g,'_'));element.trigger('mouseenter');},getCurrentElement:function(){return this.model[this.dataField][this.pos+this.offset];},getActiveElement:function(){return this.model[this.dataField][this.activePos+this.offset];},_checkElementIdInsideList:function(id){if(typeof id!='string')id=id.toString();if(this.options.limitedItems&&this.options.limitedItems<this.model[this.dataField].length){var item=$.grep(this.model[this.dataField],function(e){return e.id==id;});var x0=this.model[this.dataField].indexOf(item[0]);if((x0+this.options.limitedItems)>this.model[this.dataField].length)x0=this.model[this.dataField].length-this.options.limitedItems;this.menu.find('ul').empty();for(var i=x0;i<this.options.limitedItems+x0;i++){this.menu.find('ul').append(this._createElement(this.model[this.dataField][i]));}
this.menu.jcarousel('reload');this.offset=x0;}},selectActiveElement:function(){if(this.activePos!==null){this.menu.jcarousel('scrollIntoView',this.activePos);var element=$(this.menu.jcarousel('items')[this.options.activePos]);element.trigger('click');}},navTopElement:function(e){if(this.options.vertical&&this.pos>0){this._prevItem();e.stopPropagation();}},navBottomElement:function(e){if(this.options.vertical&&this.pos<this.size-1){this._nextItem();e.stopPropagation();}},navLeftElement:function(e){if(!this.options.vertical&&this.pos>0){this._prevItem();e.stopPropagation();}},navRightElement:function(e){if(!this.options.vertical&&this.pos<this.size-1){this._nextItem();e.stopPropagation();}}}));})();